<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastAPI + async-cassandra Sequence Diagrams</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #333;
            border-bottom: 2px solid #0084ff;
            padding-bottom: 10px;
        }
        
        h2 {
            color: #555;
            margin-top: 40px;
        }
        
        .diagram-section {
            margin: 30px 0;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        
        .code-block {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 10px 0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
        }
        
        .request-response {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .request-response > div {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 4px;
        }
        
        .request-response h3 {
            margin-top: 0;
            color: #666;
            font-size: 16px;
        }
        
        .mermaid {
            text-align: center;
            margin: 20px 0;
        }
        
        .navigation {
            position: fixed;
            right: 20px;
            top: 100px;
            background-color: white;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            max-width: 200px;
        }
        
        .navigation h3 {
            margin-top: 0;
            font-size: 16px;
            color: #666;
        }
        
        .navigation ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .navigation li {
            margin: 5px 0;
        }
        
        .navigation a {
            color: #0084ff;
            text-decoration: none;
            font-size: 14px;
        }
        
        .navigation a:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 1400px) {
            .navigation {
                display: none;
            }
        }
    </style>
    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#0084ff',
                primaryTextColor: '#fff',
                primaryBorderColor: '#0066cc',
                lineColor: '#5D5D5D',
                secondaryColor: '#f0f0f0',
                tertiaryColor: '#fff'
            }
        });
    </script>
</head>
<body>
    <div class="navigation">
        <h3>Quick Navigation</h3>
        <ul>
            <li><a href="#health">Health Check</a></li>
            <li><a href="#create">Create User</a></li>
            <li><a href="#get">Get User</a></li>
            <li><a href="#list">List Users</a></li>
            <li><a href="#update">Update User</a></li>
            <li><a href="#delete">Delete User</a></li>
            <li><a href="#async-perf">Async Performance</a></li>
            <li><a href="#sync-perf">Sync Performance</a></li>
            <li><a href="#lifecycle">App Lifecycle</a></li>
        </ul>
    </div>

    <div class="container">
        <h1>FastAPI + async-cassandra Sequence Diagrams</h1>
        <p>Interactive sequence diagrams showing the flow of each API endpoint in the FastAPI example application.</p>

        <div id="health" class="diagram-section">
            <h2>Health Check Endpoint</h2>
            <div class="mermaid">
sequenceDiagram
    participant Client
    participant FastAPI
    participant AsyncCassandra
    participant Cassandra
    
    Client->>FastAPI: GET /health
    FastAPI->>AsyncCassandra: session.execute("SELECT release_version FROM system.local")
    AsyncCassandra->>Cassandra: Execute query (async)
    Cassandra-->>AsyncCassandra: Query result
    AsyncCassandra-->>FastAPI: AsyncResultSet
    
    alt Success
        FastAPI-->>Client: 200 OK<br/>{"status": "healthy",<br/>"cassandra_connected": true,<br/>"timestamp": "2024-01-10T12:00:00"}
    else Database Error
        FastAPI-->>Client: 200 OK<br/>{"status": "unhealthy",<br/>"cassandra_connected": false,<br/>"timestamp": "2024-01-10T12:00:00"}
    end
            </div>
            
            <div class="request-response">
                <div>
                    <h3>Example Request</h3>
                    <div class="code-block">curl -X GET http://localhost:8000/health</div>
                </div>
                <div>
                    <h3>Example Response</h3>
                    <div class="code-block">{
    "status": "healthy",
    "cassandra_connected": true,
    "timestamp": "2024-01-10T12:34:56.789012"
}</div>
                </div>
            </div>
        </div>

        <div id="create" class="diagram-section">
            <h2>Create User Endpoint</h2>
            <div class="mermaid">
sequenceDiagram
    participant Client
    participant FastAPI
    participant Pydantic
    participant AsyncCassandra
    participant Cassandra
    
    Client->>FastAPI: POST /users<br/>{"name": "John Doe",<br/>"email": "john@example.com",<br/>"age": 30}
    FastAPI->>Pydantic: Validate UserCreate model
    
    alt Validation Success
        Pydantic-->>FastAPI: Valid data
        FastAPI->>FastAPI: Generate UUID<br/>user_id = uuid.uuid4()
        FastAPI->>AsyncCassandra: session.execute(insert_stmt,<br/>(user_id, name, email, age, now, now))
        AsyncCassandra->>Cassandra: INSERT INTO users<br/>(prepared statement)
        Cassandra-->>AsyncCassandra: Success
        AsyncCassandra-->>FastAPI: AsyncResultSet
        FastAPI-->>Client: 201 Created<br/>User object with ID
    else Validation Error
        Pydantic-->>FastAPI: ValidationError
        FastAPI-->>Client: 422 Unprocessable Entity
    else Database Error
        AsyncCassandra-->>FastAPI: QueryError
        FastAPI-->>Client: 500 Internal Server Error
    end
            </div>
            
            <div class="request-response">
                <div>
                    <h3>Example Request</h3>
                    <div class="code-block">curl -X POST http://localhost:8000/users \
  -H "Content-Type: application/json" \
  -d '{
    "name": "John Doe",
    "email": "john@example.com",
    "age": 30
  }'</div>
                </div>
                <div>
                    <h3>Example Response</h3>
                    <div class="code-block">{
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "name": "John Doe",
    "email": "john@example.com",
    "age": 30,
    "created_at": "2024-01-10T12:34:56.789012",
    "updated_at": "2024-01-10T12:34:56.789012"
}</div>
                </div>
            </div>
        </div>

        <div id="get" class="diagram-section">
            <h2>Get User by ID Endpoint</h2>
            <div class="mermaid">
sequenceDiagram
    participant Client
    participant FastAPI
    participant AsyncCassandra
    participant Cassandra
    
    Client->>FastAPI: GET /users/{user_id}
    FastAPI->>FastAPI: Validate UUID format
    
    alt Valid UUID
        FastAPI->>AsyncCassandra: session.execute(select_stmt, [user_uuid])
        AsyncCassandra->>Cassandra: SELECT * FROM users WHERE id = ?
        Cassandra-->>AsyncCassandra: Row data or empty
        AsyncCassandra-->>FastAPI: AsyncResultSet
        FastAPI->>FastAPI: result.one()
        
        alt User Found
            FastAPI-->>Client: 200 OK<br/>User object
        else User Not Found
            FastAPI-->>Client: 404 Not Found
        end
    else Invalid UUID
        FastAPI-->>Client: 400 Bad Request
    end
            </div>
        </div>

        <div id="list" class="diagram-section">
            <h2>List Users Endpoint</h2>
            <div class="mermaid">
sequenceDiagram
    participant Client
    participant FastAPI
    participant AsyncCassandra
    participant Cassandra
    
    Client->>FastAPI: GET /users?limit=20
    FastAPI->>FastAPI: Validate limit (1-100)
    FastAPI->>AsyncCassandra: session.execute("SELECT * FROM users LIMIT 20")
    AsyncCassandra->>Cassandra: Execute query (async)
    Cassandra-->>AsyncCassandra: Multiple rows
    AsyncCassandra-->>FastAPI: AsyncResultSet
    
    FastAPI->>FastAPI: Iterate async for row in result
    loop For each row
        FastAPI->>FastAPI: Create User object
    end
    
    FastAPI-->>Client: 200 OK<br/>Array of User objects
            </div>
        </div>

        <div id="update" class="diagram-section">
            <h2>Update User Endpoint</h2>
            <div class="mermaid">
sequenceDiagram
    participant Client
    participant FastAPI
    participant AsyncCassandra
    participant Cassandra
    
    Client->>FastAPI: PUT /users/{user_id}<br/>{"name": "John Smith", "age": 31}
    FastAPI->>AsyncCassandra: session.execute(select_stmt, [user_uuid])
    AsyncCassandra->>Cassandra: SELECT * FROM users WHERE id = ?
    Cassandra-->>AsyncCassandra: Existing user data
    
    alt User Exists
        FastAPI->>FastAPI: Merge updates
        FastAPI->>AsyncCassandra: session.execute(update_stmt,<br/>(name, email, age, updated_at, user_uuid))
        AsyncCassandra->>Cassandra: UPDATE users SET ... WHERE id = ?
        Cassandra-->>AsyncCassandra: Success
        FastAPI-->>Client: 200 OK<br/>Updated User object
    else User Not Found
        FastAPI-->>Client: 404 Not Found
    end
            </div>
        </div>

        <div id="delete" class="diagram-section">
            <h2>Delete User Endpoint</h2>
            <div class="mermaid">
sequenceDiagram
    participant Client
    participant FastAPI
    participant AsyncCassandra
    participant Cassandra
    
    Client->>FastAPI: DELETE /users/{user_id}
    FastAPI->>FastAPI: Validate UUID format
    FastAPI->>AsyncCassandra: session.execute(delete_stmt, [user_uuid])
    AsyncCassandra->>Cassandra: DELETE FROM users WHERE id = ?
    Cassandra-->>AsyncCassandra: Success
    AsyncCassandra-->>FastAPI: AsyncResultSet
    FastAPI-->>Client: 204 No Content
            </div>
        </div>

        <div id="async-perf" class="diagram-section">
            <h2>Async Performance Test</h2>
            <div class="mermaid">
sequenceDiagram
    participant Client
    participant FastAPI
    participant AsyncCassandra
    participant Cassandra
    
    Client->>FastAPI: GET /performance/async?requests=100
    FastAPI->>FastAPI: Start timer
    
    par Concurrent Execution
        loop 100 times
            FastAPI->>AsyncCassandra: session.execute("SELECT * FROM users LIMIT 1")
        end
        
        Note over AsyncCassandra,Cassandra: All 100 queries execute<br/>concurrently using asyncio.gather()
        
        AsyncCassandra->>Cassandra: Multiple concurrent queries
        Cassandra-->>AsyncCassandra: Query results
        AsyncCassandra-->>FastAPI: AsyncResultSets
    end
    
    FastAPI->>FastAPI: Stop timer<br/>Calculate metrics
    FastAPI-->>Client: 200 OK<br/>Performance metrics
            </div>
            
            <p><strong>Key Point:</strong> All queries execute concurrently, completing in approximately the time of a single query.</p>
        </div>

        <div id="sync-perf" class="diagram-section">
            <h2>Sync Performance Test (Simulated)</h2>
            <div class="mermaid">
sequenceDiagram
    participant Client
    participant FastAPI
    
    Client->>FastAPI: GET /performance/sync?requests=100
    FastAPI->>FastAPI: Start timer
    
    loop 100 times (Sequential)
        FastAPI->>FastAPI: await asyncio.sleep(0.01)<br/>(Simulate 10ms query)
        Note right of FastAPI: Each request waits for<br/>the previous to complete
    end
    
    FastAPI->>FastAPI: Stop timer<br/>Calculate metrics
    FastAPI-->>Client: 200 OK<br/>Performance metrics
            </div>
            
            <p><strong>Key Point:</strong> Each query must wait for the previous one to complete, resulting in linear time growth.</p>
        </div>

        <div id="lifecycle" class="diagram-section">
            <h2>Application Lifecycle</h2>
            <div class="mermaid">
sequenceDiagram
    participant System
    participant FastAPI
    participant AsyncCluster
    participant AsyncCassandraSession
    participant Cassandra
    
    System->>FastAPI: Application startup
    FastAPI->>AsyncCluster: Create cluster with config
    FastAPI->>AsyncCluster: cluster.connect()
    AsyncCluster->>Cassandra: Establish connection
    Cassandra-->>AsyncCluster: Connection established
    AsyncCluster-->>FastAPI: AsyncCassandraSession
    
    FastAPI->>AsyncCassandraSession: Create keyspace if not exists
    FastAPI->>AsyncCassandraSession: Create users table if not exists
    FastAPI->>AsyncCassandraSession: Prepare all statements
    
    FastAPI-->>System: Application ready
    
    Note over System,Cassandra: Application serves requests...
    
    System->>FastAPI: Application shutdown
    FastAPI->>AsyncCassandraSession: session.close()
    FastAPI->>AsyncCluster: cluster.shutdown()
    FastAPI-->>System: Cleanup complete
            </div>
        </div>

        <div class="diagram-section">
            <h2>Performance Comparison</h2>
            <div class="mermaid">
gantt
    title Query Execution Timeline (100 queries)
    dateFormat X
    axisFormat %L ms
    
    section Async
    All Queries    :active, a1, 0, 10
    Total Time     :milestone, 10, 0
    
    section Sync
    Query 1        :s1, 0, 10
    Query 2        :s2, 10, 10
    Query 3        :s3, 20, 10
    ...            :s4, 30, 970
    Total Time     :milestone, 1000, 0
            </div>
            
            <p><strong>Performance Impact:</strong> Async operations can be 10-100x faster for concurrent workloads compared to synchronous operations.</p>
        </div>
    </div>
</body>
</html>